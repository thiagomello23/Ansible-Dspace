- name: Instalando Node.js 20 e PM2
  hosts: all
  become: yes
  vars:
    user_name: ubuntu
    nvm_version: v0.39.7
    node_version: "20"

  tasks:
    - name: Instalando dependências
      apt:
        name:
          - curl
          - build-essential
        state: present
        update_cache: yes

    - name: Copiando Node.js prebuilt para o servidor
      copy:
        src: "{{ home }}/artifacts/node-v22.19.0-linux-x64.tar.xz"
        dest: "/usr/local/src/node.tar.xz"
        mode: '0644'

    - name: Extraindo Node.js
      unarchive:
        src: "/usr/local/src/node.tar.xz"
        dest: "/usr/local/src/"
        remote_src: yes
        creates: "/usr/local/src/node-v22.19.0-linux-x64"

    - name: Movendo Node.js para /usr/local
      command: mv /usr/local/src/node-v22.19.0-linux-x64 /usr/local/node-22
      args:
        creates: "/usr/local/node-22"

    - name: Criando links simbólicos
      file:
        src: "/usr/local/node-22/bin/{{ item }}"
        dest: "/usr/local/bin/{{ item }}"
        state: link
      loop:
        - node
        - npm
        - npx

    - name: Verificando versão do Node
      command: node -v
      register: node_version_out
    
     
    - name: Instalando PM2 globalmente
      become: false
      shell: |
        source ~/.nvm/nvm.sh
        npm install -g pm2
      args:
        chdir: "/home/{{ user_name }}"
        executable: /bin/bash
